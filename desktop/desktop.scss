/// =======================================================
///  Utility: str-split  (MIT: https://github.com/sass-projects/stringy)
/// =======================================================
@function str-split($string, $separator: null, $limit: null) {
  $string: unquote($string);
  @if type-of($string) != "string" { @error "`str-split` expects a string; #{type-of($string)} given."; }

  $result: zip(());
  @if not $separator { @return ($string); }

  @if $separator == "" {
    @for $i from 1 through str-length($string) { $result: append($result, str-slice($string, $i, $i)); }
    @return $result;
  }

  $running: true;
  $progress: $string;
  $length: str-length($separator);

  @while $running {
    $index: str-index($progress, $separator);
    @if $index {
      $result: append($result, str-slice($progress, 1, ($index - 1)));
      $progress: str-slice($progress, ($index + $length));
    } @else { $running: false; }
  }

  $result: append($result, $progress);

  @if $limit and $limit > 0 {
    $limit: if($limit > length($result), length($result), $limit);
    $return: ();
    @for $i from 1 through $limit { $return: append($return, nth($result, $i)); }
    @return $return;
  }

  @return $result;
}

/// =======================================================
///  Map theme settings → classes
/// =======================================================
$values: $blog_category;
$split-values: str-split($values, ",");
@each $value in $split-values { .category-#{$value} { @extend %blog-category; } }

$values: $blog_tag;
$split-values: str-split($values, "|");
@each $value in $split-values { .tag-#{$value} { @extend %blog-tag; } }

.comments-heading { display: none; }

/// =======================================================
///  Global CSS variables (top-level; not nested)
/// =======================================================
:root{
  /* site gutters */
  --mobile-gutter: 10px;

  /* callout layout knobs */
  --callout-rail: 10px;
  --callout-radius: 10px;
  --callout-pad-y: 12px;
  --callout-pad-x: 16px;
  --callout-icon-size: 26px;
  --callout-icon-gap: 12px;
  --callout-left-pad: 18px;  /* start of icon lane inside the box */
  --callout-icon-nudge: -2px;

  /* callout color tokens */
  --tone-term-bg:      #F8F7EE;  /* TERM */
  --tone-term-accent:  #C29A78;

  --tone-warn-bg:      #FFF3E6;  /* HEADS UP */
  --tone-warn-accent:  #F59E0B;

  --tone-pro-bg:       #ECF8F4;  /* PRO TIP */
  --tone-pro-accent:   #22C55E;

  --tone-note-bg:      #EEF2F7;  /* NOTE */
  --tone-note-accent:  #8FA7D6;

  --tone-success-bg:   #EAF2FF;  /* SUCCESS */
  --tone-success-accent:#5A7BEA;

  --tone-time-bg:      #FCE7F3;  /* ESTIMATED TIME */
  --tone-time-accent:  #DB2777;
}

/* Dark-mode softening for callouts */
@media (prefers-color-scheme: dark){
  :root{
    --tone-term-bg:       hsl(45 25% 85% / .10);
    --tone-warn-bg:       hsl(30 90% 80% / .10);
    --tone-pro-bg:        hsl(160 50% 80% / .10);
    --tone-note-bg:       hsl(220 30% 85% / .10);
    --tone-success-bg:    hsl(225 80% 85% / .10);

    --tone-term-accent:   #D6B48A;
    --tone-warn-accent:   #FDBA74;
    --tone-pro-accent:    #34D399;
    --tone-note-accent:   #A8B9E6;
    --tone-success-accent:#7C92F2;
  }
}

/// =======================================================
///  Blog base styling
/// =======================================================
%blog-tag,
%blog-category {
  .topic-timeline { display: none; }

  .blog-image-container {
    text-align: center;
    .blog-image {
      background-position: center center;
      background-repeat: no-repeat;
      background-size: contain;
      height: 440px;
      margin-bottom: 1em;
      @if $image_display_style == "responsive crop" { background-size: cover; width: 100%; }
    }
  }

  /* Hide the byline under the title on the first post */
  #post_1 .topic-avatar,
  #post_1 .topic-body .topic-meta-data,
  #post_1 .post-info.edits { display: none !important; }

  .topic-body { width: 100%; }

  .topic-avatar {
    height: 20px; width: 20px; background: none;
    img.avatar { height: 20px; width: 20px; }
    .avatar-flair {
      background-size: 8px 8px;
      width: 10px; height: 10px;
      top: unset; bottom: -5px; right: -3px;
      .d-icon { height: .45em; width: .45em; }
    }
  }

  .topic-map.--bottom { display: none !important; }

  #post_1 {
    .topic-body {
      padding-top: 8px; border-top: none;
      &.highlighted { animation: none; }
      .contents { border-top: 1px solid var(--primary-low); margin-left: 0; padding: 0; }
    }

    .topic-map.--op { padding-left: 0;
      .comments-heading { display: block; width: 100%; margin-top: 1em; }
      .topic-map__users-list { display: none; }
    }

    .cooked {
      big { font-size: 2rem; line-height: 2rem; letter-spacing: 1px; display: inline-block; font-family: Georgia; }
      & > p:first-child + div.lightbox-wrapper { display: none; & + p { margin-top: -15px; } }
      & > p img:not(.emoji) { display: none; }
      & > p ~ p img:not(.emoji) { display: block; }
    }
  }

  .timeline-toggle,
  #topic-progress-wrapper.docked,
  .timeline-container.timeline-docked { display: none !important; }

  /* Base centered layout (overridden by the wide layout when applied) */
  .container.posts {
    justify-content: center;
    grid-template-columns: 65% 5%;
    & > .row { width: 750px; }
    .topic-navigation .d-toc-main { min-width: 11.25em; }
  }

  #topic-title { display: flex; justify-content: center;
    .title-wrapper { width: 70%; .topic-category { margin-top: .25em; } }
  }

  .topic-area > .loading-container { max-width: 750px; }

  @media (max-width: 1350px) {
    .container.posts {
      justify-content: center;
      grid-template-columns: 65% 15%;
      & > .row { width: unset; }
      .topic-navigation { margin-left: 1em; }
    }
    #topic-title .title-wrapper { width: 80%; }
  }

  @media (max-width: 924px) {
    .container.posts { grid-template-columns: 100%; }
    #topic-title { justify-content: flex-start; }
  }
}

/// =======================================================
///  Headings (with extra vertical padding on H1)
/// =======================================================
.cooked h1,
.cooked h2 {
  padding-inline: .5em;
  margin-top: 2em;
  margin-bottom: 1em;
}
.cooked h1 { background: #000; color: #fff; padding-block: 1em; }
.cooked h2 { background: #cfd8a4; color: #000; }

/* Never add horizontal padding to the cooked body; layout handles gutters */
.topic-post .cooked { padding-inline: 0 !important; }

/// =======================================================
///  Wide, two-column “builder” layout
/// =======================================================
%builder-wide-layout {
  /* knobs */
  --page-gutter: clamp(10px, 2.5vw, 16px);
  --toc-gap: 1.5rem;

  --toc-width-min: 20rem;
  --toc-width-max: 24rem;

  --content-cap: clamp(1020px, 80ch, 1500px);
  --toc-trailing-space: 100px;

  --grid-max: calc(
    var(--content-cap) + var(--toc-gap) + var(--toc-width-max) +
    var(--toc-trailing-space) + 2 * var(--page-gutter)
  );

  --left-rail: 288px;
  --site-max: calc(var(--left-rail) + var(--grid-max));

  .wrap, .d-wrap, #main-outlet-wrap, #main-outlet {
    max-width: none !important;
    width: 100% !important;
    padding-left: var(--page-gutter) !important;
    padding-right: var(--page-gutter) !important;
  }

  #topic-title { justify-content: flex-start !important; }
  #topic-title .title-wrapper {
    width: 100% !important;
    max-width: var(--content-cap) !important;
    margin: 0 !important; padding: 0 !important;
  }

  .container.posts {
    display: grid !important;
    width: min(100%, var(--grid-max));
    margin-inline: auto;

    grid-template-columns:
      minmax(0, 1fr)
      minmax(var(--toc-width-min), var(--toc-width-max)) !important;

    column-gap: var(--toc-gap) !important;
    justify-content: stretch !important;

    padding-right: var(--toc-trailing-space);
  }
  .container.posts > .row { width: auto !important; }

  .topic-post .topic-body {
    margin-left: 0 !important;
    padding-left: 0 !important;
    max-width: var(--content-cap) !important;
    width: 100% !important;
  }
  .topic-post .cooked { padding-inline: 0 !important; }

  .container.posts .topic-navigation {
    grid-column: 2 / 3;
    align-self: start;
    position: sticky; top: 6rem;
    margin: 0;
  }
  .container.posts .topic-navigation .d-toc-main {
    min-width: var(--toc-width-min) !important;
    max-width: var(--toc-width-max) !important;
  }
  .container.posts .topic-navigation .d-toc-main ul,
  .container.posts .topic-navigation .d-toc-main li { max-width: none !important; }
  .container.posts .topic-navigation .d-toc-main li a,
  .container.posts .topic-navigation .d-toc-item > a {
    display: block !important;
    width: 100% !important;
    max-width: none !important;
    white-space: normal !important;
    overflow-wrap: anywhere;
    padding-right: .25rem;
  }

  @media (min-width: 1600px) {
    .wrap, .d-wrap, #main-outlet-wrap, #main-outlet {
      width: min(100%, var(--site-max)) !important;
      margin-inline: auto !important;
    }
  }

  @media (max-width: 1800px) { & {
    --toc-width-min: 18rem; --toc-width-max: 20rem; --toc-gap: 1.25rem; --toc-trailing-space: 64px; } }
  @media (max-width: 1600px) { & {
    --toc-width-min: 16rem; --toc-width-max: 18rem; --toc-gap: 1.25rem; --toc-trailing-space: 48px; } }
  @media (max-width: 1440px) { & {
    --toc-width-min: 14rem; --toc-width-max: 16rem; --toc-gap: 1rem; --toc-trailing-space: 32px; } }
  @media (max-width: 1280px) { & {
    --toc-width-min: 12rem; --toc-width-max: 14rem; --toc-gap: .75rem; --toc-trailing-space: 16px; } }

  /* Mobile: stack & give equal 10px gutters left/right */
  @media (max-width: 924px) {
    .container.posts {
      grid-template-columns: 1fr !important;
      column-gap: 0 !important;
      padding-inline: var(--mobile-gutter) !important;
    }

    .container.posts .topic-navigation { grid-column: 1 / -1; position: static; margin-top: 1rem; }

    .topic-post .topic-body,
    .topic-post .cooked { padding-inline: 0 !important; }

    /* avoid overflow from callouts */
    .cooked blockquote { margin-right: 0; }
  }
}

/* Apply the wide layout to each category slug listed in $blog_category */
@each $slug in str-split($blog_category, ",") {
  body.category-#{$slug}.archetype-regular { @extend %builder-wide-layout; }
}

/// =======================================================
///  Emoji callouts (blockquote-based, classless)
/// =======================================================

/* Base box for blockquotes whose FIRST paragraph begins with an emoji / icon */
.cooked blockquote:has(> p:first-child img.emoji),
.cooked blockquote:has(> p:first-child .d-icon),
.cooked blockquote:has(> p:first-child img:not(.emoji)) {
  --callout-bg: var(--primary-very-low);
  --callout-accent: var(--primary-low-mid);

  position: relative;
  background: var(--callout-bg);
  border-left: var(--callout-rail) solid var(--callout-accent);
  border-radius: var(--callout-radius);
  padding: var(--callout-pad-y) var(--callout-pad-x);
  margin: 16px 0 16px 25px;

  /* reserve an internal icon lane so the icon sits inside the box */
  padding-left: calc(
    var(--callout-left-pad) + var(--callout-icon-size) + var(--callout-icon-gap)
  ) !important;
}

/* Remove theme’s decorative open-quote/close-quote for these callouts */
.cooked blockquote:has(> p:first-child img.emoji)::before,
.cooked blockquote:has(> p:first-child .d-icon)::before,
.cooked blockquote:has(> p:first-child img:not(.emoji))::before,
.cooked blockquote:has(> p:first-child img.emoji)::after,
.cooked blockquote:has(> p:first-child .d-icon)::after,
.cooked blockquote:has(> p:first-child img:not(.emoji))::after { content: none !important; }

/* Place the icon inside the callout and vertically center it */
.cooked blockquote:has(> p:first-child img.emoji) > p:first-child img.emoji,
.cooked blockquote:has(> p:first-child .d-icon) > p:first-child .d-icon,
.cooked blockquote:has(> p:first-child img:not(.emoji)) > p:first-child img:not(.emoji){
  position: absolute !important;
  left: var(--callout-left-pad);
  top: 50%;
  transform: translateY(calc(-50% + var(--callout-icon-nudge)));
  width: var(--callout-icon-size);
  height: var(--callout-icon-size);
}

/* Title line spacing */
.cooked blockquote:has(> p:first-child img.emoji) > p:first-child,
.cooked blockquote:has(> p:first-child .d-icon) > p:first-child,
.cooked blockquote:has(> p:first-child img:not(.emoji)) > p:first-child {
  margin: 0 0 4px 0 !important;
}

/* Per-emoji color themes */
.cooked blockquote:has(> p:first-child img.emoji[title=":closed_book:"]) {
  --callout-bg: var(--tone-term-bg);
  --callout-accent: var(--tone-term-accent);
}
.cooked blockquote:has(> p:first-child img.emoji[title=":warning:"]) {
  --callout-bg: var(--tone-warn-bg);
  --callout-accent: var(--tone-warn-accent);
}
.cooked blockquote:has(> p:first-child img.emoji[title=":hammer_and_wrench:"]) {
  --callout-bg: var(--tone-pro-bg);
  --callout-accent: var(--tone-pro-accent);
}
.cooked blockquote:has(> p:first-child img.emoji[title=":information_source:"]) {
  --callout-bg: var(--tone-note-bg);
  --callout-accent: var(--tone-note-accent);
}
.cooked blockquote:has(> p:first-child img.emoji[title=":sports_medal:"]) {
  --callout-bg: var(--tone-success-bg);
  --callout-accent: var(--tone-success-accent);
}
.cooked blockquote:has(> p:first-child img.emoji[title=":stopwatch:"]) {
  --callout-bg: var(--tone-time-bg);
  --callout-accent: var(--tone-time-accent);
}

/* Text rhythm inside callouts */
.cooked blockquote p + p { margin-top: .25rem; }
.cooked blockquote strong { font-weight: 700; }

/* Mobile: collapse the icon lane and keep the icon inline */
@media (max-width: 640px){
  .cooked blockquote:has(> p:first-child img.emoji),
  .cooked blockquote:has(> p:first-child .d-icon),
  .cooked blockquote:has(> p:first-child img:not(.emoji)){
    padding-left: var(--callout-pad-x) !important;
  }
  .cooked blockquote > p:first-child{
    display: flex; align-items: center; gap: .5rem;
  }
  .cooked blockquote > p:first-child img.emoji,
  .cooked blockquote > p:first-child .d-icon,
  .cooked blockquote > p:first-child img:not(.emoji){
    position: static !important;
    width: 22px; height: 22px; transform: none !important;
  }
}
